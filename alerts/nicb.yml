groups:

###################################################################
# NICB
###################################################################

  - name: NICB System Metrics
    interval: 30s
    #concurrency: 2
    rules:
      - alert: OpenShiftQuotaMemoryLimit
        expr: |
          (sum (kube_resourcequota{resource="limits.memory",type="used" , namespace=~".*nicb.*"}) by (namespace) ) / (sum (kube_resourcequota{resource="limits.memory",type="hard" , namespace=~".*nicb.*"}) by (namespace) ) *100 > 90
        for: 10m
        labels:
          severity: warning
        annotations:
          dashboard: "https://grafana.bank.rrr.vip-clients:3000/d/4324324342/openshift-projects?orgId=1&refresh=1m&var-origin_prometheus=OCP4%20TEST&var-Namespace=nicb-test"
          summary: "Low resourcequota, current usage above 85%"
          description: "Current value: {{ $value }} ."
      - alert: OpenShiftQuotaMemoryRequest
        expr: |
          (sum (kube_resourcequota{resource="requests.memory",type="used" , namespace=~".*nicb.*"}) by (namespace) ) / (sum (kube_resourcequota{resource="requests.memory",type="hard" , namespace=~".*nicb.*"}) by (namespace) ) *100 > 85
        for: 10m
        labels:
          severity: warning
        annotations:
          dashboard: "https://grafana.bank.rrr.vip-clients:3000/d/4324324342/openshift-projects?orgId=1&refresh=1m&var-origin_prometheus=OCP4%20TEST&var-Namespace=nicb-test"
          summary: "Low resourcequota, current usage above 85%"
          description: "Current value: {{ $value }} ."
      - alert: OpenShiftQuotaCPURequest
        expr: |
          (sum (kube_resourcequota{resource="requests.cpu",type="used" , namespace=~".*nicb.*"}) by (namespace) ) / (sum (kube_resourcequota{resource="requests.cpu",type="hard" , namespace=~".*nicb.*"}) by (namespace) ) *100 > 90
        for: 10m
        labels:
          severity: warning
        annotations:
          dashboard: "https://grafana.bank.rrr.vip-clients:3000/d/4324324342/openshift-projects?orgId=1&refresh=1m&var-origin_prometheus=OCP4%20TEST&var-Namespace=nicb-test"
          summary: "Low resourcequota, current usage above 85%"
          description: "Current value: {{ $value }} ."
      - alert: OpenShiftMemoryUsage
        expr: |
          (sum (container_memory_working_set_bytes{ container != "POD",  image != "", namespace=~".*nicb.*" }) by (namespace, pod_name, pod, origin_prometheus) /(sum (kube_pod_container_resource_limits_memory_bytes {container_name != "POD", container != "POD", image != "undefined", namespace=~".*nicb.*"}) by (namespace, pod, origin_prometheus))) * 100 > 96
        for: 30s
        labels:
          severity: warning
        annotations:
          dashboard: "https://grafana.bank.rrr.vip-clients:3000/d/4324324342/openshift-projects?orgId=1&refresh=1m&var-origin_prometheus=OCP4%20TEST&var-Namespace=nicb-test"
          summary: "  High MEMORY USAGE, current usage above 96%."
          description: "{{ $labels.origin_prometheus }} Current MEMORY USAGE: {{ $value }} ."
      - alert: OpenShiftMemoryUsagePanic
        expr: |
          (sum (container_memory_working_set_bytes{ container != "POD",  image != "", namespace=~".*nicb.*" }) by (namespace, pod_name, pod) /(sum (kube_pod_container_resource_limits_memory_bytes {container_name != "POD", container != "POD", image != "undefined", namespace=~".*nicb.*"}) by (namespace, pod))) * 100 > 99 
        for: 5s
        labels:
          severity: panic
        annotations:
          dashboard: "https://grafana.bank.rrr.vip-clients:3000/d/4324324342/openshift-projects?orgId=1&refresh=1m&var-origin_prometheus=OCP4%20TEST&var-Namespace=nicb-test"
          summary: "  High MEMORY USAGE, current usage above 99%."
          description: "Current value: {{ $value }} ."
#      - alert: ProdOOMKIlled
#        expr: |
#          kube_pod_container_status_last_terminated_reason {namespace = "nicb", reason = "OOMKilled"} >= 1
#        for: 30s
#        labels:
#          severity: panic
#        annotations:
#          dashboard: "https://grafana.bank.rrr.vip-clients:3000/d/huoXV3lMk/nicb-pod-health?orgId=1&var-cluster=OCP4%20PROD&var-namespace=nicb&var-component="
#          summary: "  High MEMORY USAGE, POD terminated."
#          description: "{{$labels.origin_prometheus}}. POD {{$labels.pod}} OOMKilled ."
      - alert: ProdPodWaiting
        expr: |
          sum (kube_pod_container_status_waiting_reason {reason=~"CrashLoopBackOff|ErrImagePull|CreateContainerConfigError|ImagePullBackOff", namespace=~"nicb"}) by (pod, reason) >= 1
        for: 30s
        labels:
          severity: high
        annotations:
          dashboard: "https://grafana.bank.rrr.vip-clients:3000/d/huoXV3lMk/nicb-pod-health?orgId=1&var-cluster=OCP4%20PROD&var-namespace=nicb&var-component="
          summary: "  Pod waiting status."
          description: "POD {{$labels.pod}} waiting status is  {{$labels.reason}}."
      - alert: ProdPodRestart
        expr: |
          rate ( kube_pod_container_status_restarts_total {namespace = "nicb"} [10m] ) * 600 >= 2
        for: 30s
        labels:
          severity: panic
        annotations:
          dashboard: "https://grafana.bank.rrr.vip-clients:3000/d/4324324342/openshift-projects?orgId=1&refresh=1m&var-origin_prometheus=OCP3%20PROD&var-Namespace=nicb"
          summary: "  Too many restarts."
          description: "POD {{$labels.pod}} restarting more the 2 times in 10 min."
      - alert: ProdPodNotReady
        expr: |
          sum(kube_pod_status_ready { condition = "true", pod !~ ".+-deploy", namespace=~"nicb", deployconfig !~ ".*notification.*"}  == 0) by (origin_prometheus, namespace, pod)
        for: 300s
        labels:
          severity: panic
        annotations:
          dashboard: "https://grafana.bank.rrr.vip-clients:3000/d/huoXV3lMk/nicb-pod-health?orgId=1&var-cluster=OCP4%20PROD&var-namespace=nicb&var-component="
          summary: "POD not ready."
          description: "POD {{$labels.pod}} not ready."

